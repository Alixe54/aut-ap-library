{% extends "base.html" %}

{% block content %}

<script>
    async function handleReservation(bookId) {
    const userId = document.getElementById('user_id_input').value.trim();
    const errorElement = document.getElementById('error-message');
    errorElement.textContent = '';

    try {
        // Validate user ID format first
        if (!userId || isNaN(userId)) {
            throw new Error('Invalid User ID format - must be a number');
        }

        const response = await fetch(`/api/v1/books/${bookId}/reserve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: userId })
        });

        const contentType = response.headers.get('content-type');
        let errorData;

        if (contentType?.includes('application/json')) {
            errorData = await response.json();
        } else {
            const text = await response.text();
            errorData = { error: text };
        }

        if (!response.ok) {
            throw new Error(errorData.error || 'Reservation failed');
        }

        location.reload();
    } catch (error) {
        errorElement.textContent = error.message;
        console.error('Reservation error:', error);

        // Special handling for invalid user IDs
        if (error.message.includes('User not found')) {
            errorElement.innerHTML += '<br>Check existing users:';
            // Optionally fetch and display valid user IDs
        }
    }
}

</script>
<div class="details-card">
    <h1>{{ book.title }}</h1>
    <p><strong>ID:</strong> {{ book.id }}</p>
    <p><strong>Author:</strong> {{ book.author }}</p>
    <p><strong>ISBN:</strong> {{ book.isbn }}</p>
    <p><strong>Status:</strong>
        <span class="status {% if book.is_reserved %}reserved{% else %}available{% endif %}">
            {% if book.is_reserved %}Reserved by User #{{ book.reserved_by.user_id }}{% else %}Available{% endif %}
        </span>
    </p>

   <div class="reservation-section">
    {% if book.is_reserved %}
        <button onclick="handleRelease('{{ book.id }}')" class="btn btn-danger">
            Release Reservation
        </button>
    {% else %}
        <div class="form-group">
            <label for="user_id_input">User ID:</label>
            <input type="text" id="user_id_input" required
                   placeholder="Enter user ID (e.g., '6')">
        </div>
        <button onclick="handleReservation('{{ book.id }}')" class="btn btn-primary">
            Reserve Book
        </button>
    {% endif %}
    <div id="error-message" class="error-message"></div>
</div>
</div>
{% endblock %}